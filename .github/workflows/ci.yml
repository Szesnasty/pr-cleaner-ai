name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Verify postinstall is idempotent
        run: |
          node scripts/postinstall.js || true
          node scripts/postinstall.js || true

      - name: Build
        run: npm run build

      - name: Clean source maps
        run: npm run clean:maps

      - name: Check for source maps
        run: |
          if find dist -name '*.map' | grep -q .; then
            echo "❌ Source maps found in dist/ - should be removed before publish"
            exit 1
          fi
          echo "✅ No source maps in dist/"

      - name: Run security audit
        run: npm audit --omit=dev --audit-level=moderate
        continue-on-error: true

      - name: Validate tarball contents
        run: |
          npm pack --json --dry-run > pack.json
          node -e "
            const f = require('./pack.json');
            const files = f[0].files.map(x => x.path);
            // Allow .d.ts files (TypeScript definitions), but not .ts source files
            const forbidden = files.filter(p => /\.ts$/.test(p) && !/\.d\.ts$/.test(p) || /^src\/|^tests?\//.test(p));
            if (forbidden.length > 0) {
              console.error('❌ Forbidden files in tarball:', forbidden);
              process.exit(1);
            }
            console.log('✅ Tarball contents validated');
          "

